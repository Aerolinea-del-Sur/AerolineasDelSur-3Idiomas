<IfModule mod_rewrite.c>
    <IfModule mod_negotiation.c>
        Options -MultiViews -Indexes
    </IfModule>

    RewriteEngine On

    # Handle Authorization Header
    RewriteCond %{HTTP:Authorization} .
    RewriteRule .* - [E=HTTP_AUTHORIZATION:%{HTTP:Authorization}]

    # Handle X-XSRF-Token Header
    RewriteCond %{HTTP:x-xsrf-token} .
    RewriteRule .* - [E=HTTP_X_XSRF_TOKEN:%{HTTP:X-XSRF-Token}]

    # Redirect Trailing Slashes If Not A Folder...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_URI} (.+)/$
    RewriteRule ^ %1 [L,R=301]

    # Send Requests To Front Controller...
    RewriteCond %{REQUEST_FILENAME} !-d
    RewriteCond %{REQUEST_FILENAME} !-f
    RewriteRule ^ index.php [L]
    
    # =============================================
    # üîí BLOQUEO DE SEGURIDAD - PROYECTO AERONAVES
    # =============================================
    
    # üîê BLOQUEAR ARCHIVOS SENSIBLES
    <FilesMatch "\.(env|log|ini|config|sql|bak|backup)$">
        Order allow,deny
        Deny from all
        Satisfy All
    </FilesMatch>

    # üîê BLOQUEAR ACCESO DIRECTO A PHP (excepto index.php)
    <FilesMatch "\.(php)$">
        Order allow,deny
        Deny from all
    </FilesMatch>

    <Files "index.php">
        Order allow,deny
        Allow from all
    </Files>
    <Files "robots.txt">
        Order allow,deny
        Allow from all
    </Files>


    # üö´ BLOQUEAR SCANNERS Y BOTS MALICIOSOS
    RewriteCond %{HTTP_USER_AGENT} (nikto|wget|python|nikto|curl|scan|acunetix|sqlmap) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (havij|libwww-perl|winhttp|python|clshttp|loader) [NC,OR]
    RewriteCond %{HTTP_USER_AGENT} (webcrawl|netspider|bot|spider|robot|crawler|fake) [NC]
    RewriteRule ^(.*)$ - [F,L]

    # üìÅ PROTEGER CARPETAS SENSIBLES DE LARAVEL
    RewriteRule ^(app|bootstrap|config|database|resources|routes|storage|tests|vendor)/(.*) - [F,L,NC]

    # üõ°Ô∏è BLOQUEAR ACCESO A ARCHIVOS OCULTOS
    RewriteCond %{SCRIPT_FILENAME} -d [OR]
    RewriteCond %{SCRIPT_FILENAME} -f
    RewriteRule "(^|/)\." - [F,L]
</IfModule>

# =============================================
# üöÄ OPTIMIZACIONES DE SEGURIDAD Y CACHE
# =============================================

<IfModule mod_headers.c>
    # Protecci√≥n contra XSS
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    
    # Protecci√≥n contra MIME Sniffing
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    
    # Referrer Policy
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # Permissions Policy
    Header always set Permissions-Policy "geolocation=(), microphone=(), camera=()"
    
    # Cache para archivos est√°ticos (im√°genes, fuentes, CSS, JS)
    <FilesMatch "\.(css|js|png|jpg|jpeg|gif|ico|svg|woff|woff2|ttf|eot|webp)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>
    
    # Cache para videos (1 a√±o)
    <FilesMatch "\.(mp4|webm|ogg|avi|mov)$">
        Header set Cache-Control "max-age=31536000, public, immutable"
    </FilesMatch>
    
    # No cache para archivos sensibles
    <FilesMatch "\.(php|html|htm)$">
        Header set Cache-Control "no-cache, no-store, must-revalidate"
    </FilesMatch>
</IfModule>

    
# Manifest MIME type for PWA compatibility
# <IfModule mod_mime.c>
#    AddType application/manifest+json .webmanifest
# </IfModule>

# =============================================
# üéØ COMPRESI√ìN Y OPTIMIZACI√ìN
# =============================================

<IfModule mod_deflate.c>
    AddOutputFilterByType DEFLATE text/plain
    AddOutputFilterByType DEFLATE text/html
    AddOutputFilterByType DEFLATE text/xml
    AddOutputFilterByType DEFLATE text/css
    AddOutputFilterByType DEFLATE application/xml
    AddOutputFilterByType DEFLATE application/xhtml+xml
    AddOutputFilterByType DEFLATE application/rss+xml
    AddOutputFilterByType DEFLATE application/javascript
    AddOutputFilterByType DEFLATE application/x-javascript
    AddOutputFilterByType DEFLATE image/svg+xml
</IfModule>

# Mensaje de error espec√≠fico
ErrorDocument 403 "üö´ Acceso Prohibido - Storage del Sistema"

# =============================================
# üì¶ STORAGE LARAVEL - ARCHIVOS DEL SISTEMA
# =============================================
# Esta carpeta contiene logs, cach√© y archivos
# temporales del framework Laravel
# =============================================

# =============================================
# üîí BLOQUEO TOTAL - CARPETA CONFIG - error de css y robots.txt
# =============================================

Order deny,allow
#Deny from all

# =============================================
# ‚öôÔ∏è CONFIGURACIONES LARAVEL - SENSIBLES
# =============================================
# Contiene configuraciones de la aplicaci√≥n
# y datos sensibles del proyecto
# =============================================

# =============================================
# üìù CONFIGURACI√ìN ADICIONAL DE SEGURIDAD
# =============================================

# Deshabilitars firma del servidor
#ServerTokens Prod

# Prevenir acceso a archivos de backup
<FilesMatch "\.(bak|backup|old|orig|original|save|sav)$">
    Order allow,deny
    Deny from all
</FilesMatch>


# Protecci√≥n contra hotlinking de im√°genes
<IfModule mod_rewrite.c>
    RewriteCond %{HTTP_REFERER} !^$
    RewriteCond %{HTTP_REFERER} !^http(s)?://(www\.)?tudominio.com [NC]
    #RewriteRule \.(jpg|jpeg|png|gif|svg)$ - [NC,F,L]
</IfModule>


# =============================================
# üîí BLOQUEO TOTAL - CARPETA RAIZ LARAVEL
# =============================================

<IfModule mod_rewrite.c>
    RewriteEngine On
    
    # Redirigir todo a la carpeta public
    #RewriteRule ^(.*)$ public/$1 [L]
    
    # Bloquear acceso directo a todo en ra√≠z
    RewriteRule ^(app|bootstrap|config|database|resources|routes|storage|tests|vendor|env) - [F,L,NC]
</IfModule>


# Bloquear acceso a todos los archivos (EXCEPTO los esenciales)
<FilesMatch "^(robots.txt|index.php)$">
    # Permitir el acceso a estos archivos espec√≠ficos
    Order allow,deny
    Allow from all
</FilesMatch>


# Excepciones solo para redirecci√≥n
<Files ".htaccess">
    Order allow,deny
    Allow from all
</Files>

# Mensajes de error personalizados
ErrorDocument 403 "üîí Acceso Denegado - Proyecto Aeronaves en Desarrollo"
ErrorDocument 404 "üìÑ P√°gina No Encontrada - Contacta al equipo de desarrollo"

# =============================================
# üöÄ PROYECTO AERONAVES - ARCHIVO RAIZ
# =============================================
# Este archivo asegura que nadie acceda directamente
# a los archivos sensibles del proyecto Laravel
# =============================================

# =============================================
# üîí BLOQUEO TOTAL - CARPETA STORAGE
# =============================================

<IfModule !mod_authz_core.c>
    Order deny,allow
    Deny from all
</IfModule>
